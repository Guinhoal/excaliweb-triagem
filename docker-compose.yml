version: '3.8'

networks:
  triagem-network:
    driver: bridge

volumes:
  postgres_data:
  n8n_data:
  evolution_data:
  nginx_logs:

services:
  # Base de dados PostgreSQL
  postgres:
    image: postgres:15-alpine
    container_name: triagem-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: triagem_db
      POSTGRES_USER: triagem_user
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-sua_senha_segura_aqui}
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-scripts:/docker-entrypoint-initdb.d
    ports:
      - "5432:5432"
    networks:
      - triagem-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U triagem_user -d triagem_db"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Backend Django
  django:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: triagem-django
    restart: unless-stopped
    environment:
      - DATABASE_URL=postgresql://triagem_user:${POSTGRES_PASSWORD:-sua_senha_segura_aqui}@postgres:5432/triagem_db
      - DJANGO_DEBUG=False
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY}
      - ALLOWED_HOSTS=localhost,127.0.0.1,${DOMAIN_NAME:-triagem.example.com}
      - N8N_WEBHOOK_URL=http://n8n:5678
      - EVOLUTION_API_URL=http://evolution-api:8080
      - TZ=${TZ:-America/Sao_Paulo}
    volumes:
      - ./backend:/app
      - ./media:/app/media
      - ./static:/app/static
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - triagem-network
    command: ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "--timeout", "120", "triagem_excaliweb.wsgi:application"]

  # Frontend Angular servido pelo Nginx
  nginx:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: triagem-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./nginx/blank.conf:/etc/nginx/conf.d/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
      - nginx_logs:/var/log/nginx
    depends_on:
      - django
    networks:
      - triagem-network

  # N8N para orquestração
  n8n:
    image: n8nio/n8n:latest
    container_name: triagem-n8n
    restart: unless-stopped
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-admin123}
      - N8N_HOST=${DOMAIN_NAME:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      # Configurações essenciais para proxy reverso com prefixo
      - N8N_PATH=/n8n/
      - N8N_EDITOR_BASE_URL=http://${DOMAIN_NAME:-localhost}/n8n/
      - WEBHOOK_URL=http://${DOMAIN_NAME:-localhost}/n8n/
      # Configurações específicas para assets e roteamento
      - N8N_SERVE_STATIC=true
      - N8N_PROXY_ASSETS=true
      - N8N_FRONTEND_BASE_URL=/n8n/
      - VUE_APP_URL_BASE_API=/n8n/
      # Configurações de segurança para HTTP (não HTTPS)
      - N8N_SECURE_COOKIE=false
      # Configurações adicionais recomendadas
      - DB_SQLITE_POOL_SIZE=10
      - N8N_RUNNERS_ENABLED=true
      - N8N_BLOCK_ENV_ACCESS_IN_NODE=false
      - N8N_ENFORCE_SETTINGS_FILE_PERMISSIONS=false
      - GENERIC_TIMEZONE=America/Sao_Paulo
    ports:
      - "5678:5678"
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n/backup:/backup
    networks:
      - triagem-network
    depends_on:
      - postgres

  # Evolution API (WhatsApp)
  evolution-api:
    image: evoapicloud/evolution-api:latest
    container_name: triagem-evolution-api
    restart: unless-stopped
    depends_on:
      - postgres
      - redis
    ports:
      - "8080:8080"
    environment:
      # Server
      - SERVER_NAME=evolution
      - SERVER_TYPE=http
      - SERVER_PORT=${EVOLUTION_PORT:-8080}
      - SERVER_URL=http://${DOMAIN_NAME:-localhost}${EVOLUTION_PATH:-/evolution}
      # Auth
      - AUTHENTICATION_API_KEY=${EVOLUTION_API_KEY}
      # CORS e Logs
      - CORS_ORIGIN=*
      - LOG_LEVEL=ERROR,WARN,DEBUG,INFO,LOG
      # Timezone
      - TZ=${TZ:-America/Sao_Paulo}
      # Database (usa Postgres do compose, em schema dedicado)
      - DATABASE_PROVIDER=postgresql
      - DATABASE_CONNECTION_URI=postgresql://triagem_user:${POSTGRES_PASSWORD:-sua_senha_segura_aqui}@postgres:5432/triagem_db?schema=evolution_api
      - DATABASE_CONNECTION_CLIENT_NAME=evolution_exchange
      # Cache Redis (usa Redis do compose)
      - CACHE_REDIS_ENABLED=true
      - CACHE_REDIS_URI=redis://redis:6379/6
      - CACHE_REDIS_TTL=604800
      - CACHE_REDIS_PREFIX_KEY=evolution
    volumes:
      - evolution_data:/evolution/instances
    expose:
      - "8080"
    networks:
      - triagem-network
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- --header=\"apikey: $$AUTHENTICATION_API_KEY\" http://localhost:8080/instance/fetchInstances > /dev/null"]
      interval: 15s
      timeout: 5s
      retries: 10

  

  # Redis para cache (opcional, mas recomendado)
  redis:
    image: redis:7-alpine
    container_name: triagem-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - ./redis/data:/data
    networks:
      - triagem-network
    command: redis-server --appendonly yes

  # Backup automático do banco de dados
  postgres-backup:
    image: prodrigestivill/postgres-backup-local
    container_name: triagem-backup
    restart: unless-stopped
    environment:
      - POSTGRES_HOST=postgres
      - POSTGRES_DB=triagem_db
      - POSTGRES_USER=triagem_user
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-sua_senha_segura_aqui}
      - POSTGRES_EXTRA_OPTS=-Z9 --schema=public --blobs
      - SCHEDULE=@daily
      - BACKUP_KEEP_DAYS=7
      - BACKUP_KEEP_WEEKS=4
      - BACKUP_KEEP_MONTHS=6
      - HEALTHCHECK_PORT=8080
    volumes:
      - ./backups:/backups
    depends_on:
      - postgres
    networks:
      - triagem-network
